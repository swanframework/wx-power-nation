<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Full Layout - jQuery EasyUI Demo</title>
    <link rel="stylesheet" type="text/css" href="../jquery-easyui-1.7.0/themes/default/easyui.css">
    <link rel="stylesheet" type="text/css" href="../jquery-easyui-1.7.0/themes/icon.css">
    <script type="text/javascript" src="../jquery-easyui-1.7.0/jquery.min.js"></script>
    <script type="text/javascript" src="../jquery-easyui-1.7.0/jquery.easyui.min.js"></script>
    <!-- 自定义脚本和文件 -->
    <link rel="stylesheet" type="text/css" href="../custom/css/index.css">
    <script type="text/javascript" src="../custom/js/insertAtCaret.js"></script>
</head>
<body class="easyui-layout" style="width: 100%">

    <!-- 左侧: 图片预览区 -->
    <div id="left" data-options="region:'west',collapsible:false, title:'图片预览'">
        <!-- 900x1600  -->
        <img id="previewImg"><br/>
    </div>

    <!-- 右侧: 图片解析区 -->
    <div id="cnt" data-options="region:'center',title:'解析结果'">
        <div style="float: left">
            <!-- 截屏边框 -->
            <div id="border">
                <div id="signle"></div> <!-- 头部信号区域 -->

                <div id="question"> <!-- 题目背景 -->
                    <ul id="title"></ul>
                    <ul id="answer"></ul>
                </div>
            </div>
        </div>
        <!-- 按钮区 -->
        <div id="btns">
            <button type="button" class="textbox" onclick="insert('___')">插入___</button>
            <button type="button" class="textbox" onclick="insert('（ ）')">插入（ ）</button>
            <button type="button" class="textbox" onclick="insert('，')">插入，</button>
            <button type="button" class="textbox" onclick="insert('。')">插入。</button>
            <button type="button" class="textbox" onclick="mergePre()">合并至上一行</button>
            <button type="button" class="textbox" onclick="addTitleLines(1)">标题行+1</button>
            <button type="button" class="textbox" onclick="addTitleLines(-1)">标题行-1</button>
            <button type="button" class="textbox" onclick="finish()" style="margin-top: 100px">完成</button>
        </div>
    </div>

</body>
<script type="text/javascript">
    var focusId = "";
    var answer = "";
    var imageId = 1;
    var titleLines = 1;
    var answerIdx = 1;
    var imageInfo;

    function addTitleLines(lines) {
        imageInfo.titleLines += lines;
        initImage(imageInfo);
    }

    // 光标处插入文本
    function insert(str){
        $("#" + focusId).insertAtCaret(str);
    }

    function mergePre(){
        var title = $("#" + focusId).val();
        var prevId = focusId -1;
        var preTitle = $("#" + prevId).val();
        $("#" + prevId).val(preTitle + title);
        $("#" + focusId).remove();
        titleLines = titleLines -1;
    }

    // 完成选择
    function finish(){
        var titleLines = 0;
        var title = "";
        // 获取标题
        $("#title li input").each(function () {
            title += $(this).val().trim();
            titleLines++;
        });

        // 如果未选择答案,则抛出提示
        if(answer == ""){
            alert("请选择答案");
            return;
        }

        var params = "title=" + title + "&answer=" + answer + "&imageId=" + imageId
                + "&titleLines=" + titleLines + "&answerIdx=" + answerIdx;
        $.ajax({
            url:"/question",
            method:"POST",
            data: params ,
            success: function(result) {
                loadImage();
            }
        })
    }
    
    function initImage(result) {
        // 保存id
        imageId = result.imgId;

        // 替换图片
        $('#previewImg').attr('src', "/image/content/" + imageId);

        // 初始化标题
        $('#title').empty();
        for (i = 0; i < result.titleLines; i++) {
            $('#title').append("<li><input id='" + i +"' type='text' value='" + result.textLines[i] + "' onfocus='fc(this)' ></li>")
        }


        // 初始化答案
        $('#answer').empty();
        for (i = result.titleLines; i < result.textLines.length; i++) {
            $('#answer').append("<li onclick='selectAnswer(this)' idx='" + i + "'><label>" + result.textLines[i] + "</label></li>")
        }
    }

    // 加载图片
    function loadImage(){
        $.ajax({
            url:"/image/nextAnswer?category=1",
            method:"GET",
            success: function(result) {
                imageInfo = result;
                initImage(result);
            }
        })
    }

    // 选择答案, 变更颜色
    function selectAnswer(v){
        $("#answer li").each(function () {
            $(this).css("background-color","#FFF");

        });
        // 获取选中对象的文本
        answer = $($(v).children("label").get(0)).text();
        // 更改颜色
        $(v).css("background-color","#3DC074");
    }

    function fc(v){
        focusId = $(v).attr("id");
    }

    $(function () {
        $("input").focus(function () {
            focusId = $(this).attr("id");
            answerIdx = $(this).attr("idx");
        });
    });

    // 初始化加载
    loadImage();

    // setInterval(loadImage, 200);

</script>
</html>